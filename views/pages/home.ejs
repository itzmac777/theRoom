<header class="header">
    <div class="logo-div">
        <img src="./img/theRoomLogoCropped.png" height="" width="180px" alt="theRoom">
    </div>
    <div class="hero-section">
        <div>
            <div class="hero-first">
            Your private space for <span class="hero-colored">secure</span>,
        </div>
        <div class="hero-second">
            effortless <span class="hero-colored">sharing</span>.
        </div>
        </div>
    </div>
</header>

<div class="create-join-from-div">
    <div class="form">
        <div class="create-join-radio-container">
            <div>
                <input type="radio" checked value="radio-create" name="radio-join-create" id="radio-create">
                <label for="radio-create">Create</label>
            </div>
            <div>
                <input type="radio" value="radio-join" name="radio-join-create" id="radio-join">
                <label for="radio-join">Join</label>
            </div>
        </div>
        <!-- CREATE FORM -->
        <div class="create-form">
            <div class="create-form">
                <input id="rName-create" name="rName-create" type="text" placeholder="Name">
                <input id="rPassword-create" name="rPassword-create" type="text" placeholder="Password">
                <div class="timer-container">
                    <input min="0" type="number" id="hour" placeholder="hour">
                    <input min="0" type="number" id="min" placeholder="min">
                    <input min="0" type="number" id="sec" placeholder="sec">
                </div>
                <button id="rSubmit-create">Create</button>
            </div>
        </div>
        <!-- JOIN FORM -->
        <div class="join-form">
            <div class="join-form">
                <input id="rName" name="rName" type="text" placeholder="Name">
                <input id="rPassword" name="rPassword" type="text" placeholder="Password">
                <button id="rSubmit">Join</button>
            </div>
        </div>
    </div>
</div>


<div class="msg-form-container">
    <div class="msg-form" >
        <div class="name-expires-container">
            <div class="room-name">Room Name: <span id="room-id-div"></span></div>
            <div class="room-expires-in">Expires in: <span id="room-timer"></span></div>
        </div>
        <div class="file-send-info">
            <input type="file" id="file">
            <button id="send">Send</button>
        </div>
        <div id="fileList"></div>
        <button id="leave-room">Leave Room</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const form = document.querySelector(".form")
    const createForm = document.querySelector(".create-form")
    const joinForm = document.querySelector(".join-form")
    const msgForm = document.querySelector(".msg-form-container")
    const rName = document.querySelector("#rName")
    const rPassword = document.querySelector("#rPassword")
    const rSubmitBtn = document.querySelector("#rSubmit")
    const createrName = document.querySelector("#rName-create")
    const createrPassword = document.querySelector("#rPassword-create")
    const createRoomBtn = document.querySelector("#rSubmit-create")
    const sendBtn = document.querySelector("#send")
    const fileInput = document.querySelector("#file")
    const fileList = document.querySelector("#fileList")
    const roomIdDiv = document.querySelector("#room-id-div")
    const roomTimer = document.querySelector("#room-timer")
    const leaveRoom = document.querySelector("#leave-room")
    const hour = document.querySelector("#hour")
    const min = document.querySelector("#min")
    const sec = document.querySelector("#sec")
    const socket = io();
    const formRadioInputs = document.querySelectorAll(".form input[type=radio]");
    const header = document.querySelector(".hero-section")
    
    refreshForm('radio-create')
    createRoomBtn.addEventListener('click', ()=> createRoomHandler())
    rSubmitBtn.addEventListener('click', ()=> joinRoomHandler())
    sendBtn.addEventListener('click', ()=> fileSendHandler())
    leaveRoom.addEventListener('click', ()=> leaveRoomHandler())
    
    socket.on("success", (state)=> roomSuccessHandler(state))
    socket.on("error", (msg)=> alert(msg))
    socket.on("room-deleted", roomDeletionHandler)
    socket.on("msg", (msg)=> console.log(msg))
    socket.on("timer", (counter)=> counterHander(counter))
    socket.on("file-received", (fileData)=> fileRecievingHandler(fileData))

    formRadioInputs.forEach(raInput => raInput.addEventListener("change",(e)=> {
        refreshForm(e.target.value);
    }))

    function createRoomHandler(){
        if(hour.value < 0 || min.value < 0 || sec.value < 0){
            alert("Invalid timer");
            return
        }
        socket.emit("create-room", {rName: createrName.value, rPassword: createrPassword.value, expiresAt: [hour.value || 0, min.value || 0, sec.value || 0]})
        roomIdDiv.innerHTML = `${createrName.value}`
    }

    function joinRoomHandler(){
        socket.emit("join-room", {rName: rName.value, rPassword: rPassword.value})
        roomIdDiv.innerHTML = `${ rName.value}`
    }

    function roomSuccessHandler(state){
        if(state){
            form.style.display = 'none';
            header.style.display = 'none';
            msgForm.style.display = 'flex';
        } else{
            form.style.display = 'block'
            header.style.display = 'flex';
            msgForm.style.display = 'none'
        } 
    }

    function roomDeletionHandler(){
        socket.emit("leave-room")
        console.log("Room Deleted")
        form.style.display = 'block'
        header.style.display = 'flex'
        msgForm.style.display = 'none'
        fileList.innerHTML = ''
    }

    function fileSendHandler(){
        const file = fileInput.files[0]
        if (!file) {
            alert('Please select a file first')
            return
        }
        
        const reader = new FileReader()
        reader.onload = function(event) {
            socket.emit('file-upload', {
                filename: file.name,
                data: event.target.result,
                filesize: Math.ceil(file.size / 1000),
                sender: socket.id
            })
        }
        
        reader.onerror = function(error) {
            alert('Error reading file:', error)
        }
        reader.readAsDataURL(file)
    }

    function leaveRoomHandler(){
        socket.emit("leave-room", rName.value + rPassword.value)
        form.style.display = 'block'
        header.style.display = 'flex';
        msgForm.style.display = 'none'
        fileList.innerHTML = ''
    }

    function fileRecievingHandler(fileData){
        const link = document.createElement('a')
        link.href = fileData.data
        link.download = fileData.filename
        link.innerHTML = `ðŸ“ ${fileData.filename} ${fileData.filesize}kb`
        link.style.display = 'block'
        link.style.margin = '10px 0'
        link.style.padding = '10px'
        link.style.background = '#f0f0f0'
        link.style.textDecoration = 'none'
        link.style.color = '#333'
        link.style.borderRadius = '5px'
        fileList.appendChild(link)
    }

    function counterHander(counter){
        roomTimer.innerHTML = `${counter[0]}h ${counter[1]}m ${counter[2]}s`;
        if(counter == 1){
            setTimeout(()=> {
                roomTimer.innerHTML = ``;
            }, 1000)
        }
    }

    function refreshForm(currentFormState) {
        if(currentFormState == 'radio-join'){
            joinForm.style.display = 'block'
            createForm.style.display = 'none'
        } else{
            joinForm.style.display = 'none'
            createForm.style.display = 'block'
        }
    }
</script>